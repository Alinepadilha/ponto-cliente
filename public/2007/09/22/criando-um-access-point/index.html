<!DOCTYPE html>
<html lang="en">
<head>
    <!-- start: Meta -->
    <meta charset="utf-8">
    <title>Criando um Access Point</title>
    <meta name="description" content="Magnus Bootstrap Theme" />
    <meta name="keywords" content="Template, Theme, web, html5, css3, Bootstrap" />
    <meta name="author" content="Łukasz Holeczek from creativeLabs" />
    <!-- end: Meta -->
    
    <!-- start: Mobile Specific -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <!-- end: Mobile Specific -->
    
    <!-- start: CSS -->
    <link href="/css/bootstrap.css" rel="stylesheet">
    <link href="/css/bootstrap-responsive.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/parallax-slider.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Droid+Sans:400,700">
    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Droid+Serif">
    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Boogaloo">
    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Economica:700,400italic">
    <!-- end: CSS -->

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
        <link href="/css/ie.css" rel="stylesheet">
        <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!--[if IE 9]>
        <link href="/css/ie9.css" rel="stylesheet">
    <![endif]-->
</head>
<body>
    <!--start: Header -->
    <header>
        <!--start: Container -->
        <div class="container">
            <!--start: Navigation -->
            <div class="navbar navbar-inverse">
                <div class="navbar-inner">
                    <a class="btn btn-navbar" data-toggle="collapse"
                        data-target=".nav-collapse"> <span class="icon-bar"></span> <span
                        class="icon-bar"></span> <span class="icon-bar"></span>
                    </a> 
                    <a class="brand" href="/"><i class="ico-thin-right-arrow ico-color circle"></i> mr<span>prompt</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav">
                            <li><a href="/">Início</a></li>
                            <li><a href="/servicos">Serviços</a></li>
                            <li class="active"><a href="/blog">Blog</a></li>
                            <li><a href="/contato">Contato</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <!--end: Navigation -->

        </div>
        <!--end: Container-->

    </header>
    <!--end: Header-->

	<!-- start: Page Title -->
	<div id="page-title">
	    <div id="page-title-inner">
	        <!-- start: Container -->
	        <div class="container">
	            <h2>
	                <i class="ico-pencil"></i>Criando um Access Point
	            </h2>
	        </div>
	        <!-- end: Container  -->
	    </div>
	</div>
	<!-- end: Page Title -->
	
	<!--start: Wrapper-->
	<div id="wrapper">
	    <!--start: Container -->
	    <div class="container">
	        <!--start: Row -->
	        <div class="row">
	            <div class="span9">
	                <h2>Introdução</h2>

<p>Adquiri recentemente, uma placa Wireless 108G PCI Adapter - DWL-G520 da Dlink,
pra por no micro que já faz o roteamento da rede cabeada aqui de casa e poder
utilizar o wireless do meu notebook. Imaginei que fosse uma tarefa simples,
afinal, &quot;é só mais uma placa de rede&quot;.</p>

<p>Eu penei pra conseguir configurar, foram dois dias fuçando manuais e buscas no
Google, para enfim, chegar a essa receita de bolo.</p>

<p>A DWL-G520 vem com chipset Atheros, que é suportado nativamente pelo Linux com
o madwifi, não necessitando então do ndiswrapper, que é uma espécia de Wine
para drivers wireless se entendi bem.</p>

<p>A intenção é mesclar as redes ethernet e wireless, atribuindo IP aos clientes
via dhcp, autenticando os usuários da rede wi-fi com a chave WEP.</p>

<p>Com as três placas de rede fisicamente instaladas na máquina que irá fazer o
roteamento, aqui um K6-2 366MHz com 386Mb de RAM e Debian 4.0.</p>

<p>Dando um &quot;lspci&quot; obtenho a seguinte saída:</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">#</span> lspci
<span class="go">00:09.0 Ethernet controller: Atheros Communications, Inc. AR5212 802.11abg NIC (rev 01)</span>
<span class="go">00:0a.0 Ethernet controller: VIA Technologies, Inc. VT6105 Rhine-III rev 8b</span>
<span class="go">00:0b.0 Ethernet controller: Realtek Semiconductor Co., Ltd. RTL-8139/8139C/8139C+ (rev 10)</span></code></pre></div>

<h2>Instalando</h2>

<p>Vamos então a instalação dos pacotes via apt-get:</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">#</span> apt-get install bridge-utils dhcp3-client dhcp3-common dhcp3-server wireless-tools
<span class="gp">#</span> apt-get install ifupdown iptables madwifi-tools madwifi-source module-assistant</code></pre></div>

<p>Com a placa de rede reconhecida, e os drivers instalados, agora vamos configurar
as placas de rede, no Debian, as configurações ficam no diretório &quot;/etc/network/interfaces&quot;.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">#</span> /etc/network/interfaces
<span class="gp">#</span> Interface de Local/Loopback
<span class="go">auto lo</span>
<span class="go">iface lo inet loopback```</span>

<span class="gp">#</span> Primeira placa de rede, ligada ao switch
<span class="go">auto eth0</span>
<span class="go">allow-hotplug eth0</span>
<span class="go">iface eth0 inet static</span>
<span class="go">address 192.168.1.1</span>
<span class="go">netmask 255.255.255.0</span>

<span class="gp">#</span> Segunda placa de rede, ligada ao modem
<span class="go">auto eth1</span>
<span class="go">allow-hotplug eth1</span>
<span class="go">iface eth1 inet dhcp</span>

<span class="gp">#</span> Terceira placa de rede, wireless, habilitada via wlanconfig para trabalhar como Access Point <span class="o">(</span>AP<span class="o">)</span>
<span class="go">auto ath0</span>
<span class="go">iface ath0 inet static</span>
<span class="go">address 192.168.1.2</span>
<span class="go">netmask 255.255.255.0</span>
<span class="go">pre-up wlanconfig ath0 destroy</span>
<span class="go">pre-up wlanconfig ath0 create wlandev wifi0 wlanmode ap</span>
<span class="go">pre-up iwconfig ath0 essid &quot;Casa&quot; rate auto</span>
<span class="go">pre-up iwconfig ath0 txpower auto</span>
<span class="go">pre-up iwconfig ath0 channel 5</span>
<span class="go">pre-up iwconfig ath0 key restricted xxxxxxxxxxxxxxxxxxxxxxxxxxxx</span>
<span class="go">wireless-mode master</span></code></pre></div>

<p>Para a chave WEP, você deve utilizar uma sequencia em hexadecimal de 26 caracteres.
Reinicie o micro, ou levante as placas de rede manualmente:</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">#</span> ifconfig eth0 up
<span class="gp">#</span> ifconfig eth1 up
<span class="gp">#</span> ifconfig ath0 up</code></pre></div>

<p>Agora, todas as placas de rede possuem um IP interno e já se comunicam, se em
algum outro micro - no meu caso, a partir do notebook - eu rodar o iwlist, já
será possível encontrar a rede wireless.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">#</span> iwlist scan
<span class="go">lo        Interface doesn&#39;t support scanning.```</span>
<span class="go">eth0      Interface doesn&#39;t support scanning.</span>
<span class="go">eth1      Scan completed :</span>
<span class="go">Cell 01 - Address: 00:19:5B:3C:CF:29</span>
<span class="go">ESSID:&quot;BobMarley&quot;</span>
<span class="go">Protocol:IEEE 802.11bg</span>
<span class="go">Mode:Master</span>
<span class="go">Channel:5</span>
<span class="go">Frequency:2.432 GHz (Channel 5)</span>
<span class="go">Encryption key:on</span>
<span class="go">Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 11 Mb/s; 6 Mb/s</span>
<span class="go">9 Mb/s; 12 Mb/s; 18 Mb/s; 24 Mb/s; 36 Mb/s</span>
<span class="go">48 Mb/s; 54 Mb/s</span>
<span class="go">Quality=99/100  Signal level=-23 dBm  Noise level=-23 dBm</span>
<span class="go">Extra: Last beacon: 92ms ago</span></code></pre></div>

<p>Agora vamos habilitar o DHCP para a rede.
Edite o /etc/default/dhcp3-server para podermos informar ao servidor daemon do
DHCP, quais interfaces ele irá ouvir.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">#</span> /etc/default/dhcp3-server
<span class="go">INTERFACES=&quot;eth0 ath0&quot;</span></code></pre></div>

<p>Configuramos agora, o daemon propriamente dito, uma configuração básica é
sugerida abaixo, e deve ser salva no arquivo /etc/dhcp3/dhcpd.conf.</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">#</span> /etc/dhcp3/dhcpd.conf
<span class="go">ddns-update-style none;</span>
<span class="go">default-lease-time 600;</span>
<span class="go">max-lease-time 7200;</span>
<span class="go">authoritative;</span>
<span class="go">log-facility local7;```</span>
<span class="go">subnet 192.168.1.0 netmask 255.255.255.0 {</span>
<span class="go">    range 192.168.1.3 192.168.1.30;</span>
<span class="go">    option domain-name-servers 192.168.1.1,200.247.141.11,200.247.141.12;</span>
<span class="go">    option domain-name &quot;fln.virtua.com.br&quot;;</span>
<span class="go">    option routers 192.168.1.1;</span>
<span class="go">    default-lease-time 600;</span>
<span class="go">    max-lease-time 7200;</span>
<span class="go">}</span></code></pre></div>

<p>Reinicie o servidor DHCP e pronto</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">#</span> /etc/init.d/dhcp3-server restart</code></pre></div>

<p>Pronto, com isso, os micros conectados ao switch/hub já recebem um IP
automaticamente, para os clientes da rede Wireless também receberem um IP e
conseguir navegar, precisamos criar uma ponte, entre a placa de rede interna (eth0)
e a placa wireless (ath0):</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">#</span> ifconfig eth0 0.0.0.0 up
<span class="gp">#</span> ifconfig ath0 0.0.0.0 up
<span class="gp">#</span> brctl addbr br0
<span class="gp">#</span> brctl setfd br0 0
<span class="gp">#</span> brctl addif br0 eth0
<span class="gp">#</span> brctl addif br0 ath0
<span class="gp">#</span> ifconfig br0 192.168.1.1</code></pre></div>

<p>A rede agora está quase pronta, faltando apenas habilitar o NAT no servidor,
para que todos os micros possam utilizar a internet, para isso, vamos utilizar
o iptables.</p>

<p>Primeiro carregamos o módulo iptable_nat</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">#</span> modprobe iptable_nat</code></pre></div>

<p>Limpamos quaisquer regras que existam na tabela do iptables</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">#</span> iptables -F
<span class="gp">#</span> iptables -t nat -F
<span class="gp">#</span> iptables -t mangle -F
<span class="gp">#</span> iptables -X</code></pre></div>

<p>Ativamos o ip forward</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">#</span> <span class="nb">echo </span><span class="m">1</span> &gt; /proc/sys/net/ipv4/ip_forward</code></pre></div>

<p>Habilitando o NAT, lembrando que a eth1 é a placa de rede que está ligada ao modem</p>

<div class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">#</span> iptables -t nat -A POSTROUTING -o eth1 -j MASQUERADE</code></pre></div>

<p>Você também pode pegar os comandos que criam a interface de ponte (bridge) e
do iptables, e inserir no seu rc.local, no diretório etc, para poder rodar
sempre que o micro for iniciado.</p>

<p>How-To corrido, escrito em menos de 20min, mas ao menos tá documentado pra
galera não ficar dois dias quebrando cabeça como eu ;)</p>

	            </div>
	
	            <!-- start: Sidebar -->
	            <div class="span3 hidden-phone">
	
	                <!-- start: Text Widget -->
	                <div class="widget first">
	                    <div class="title">
	                        <h3>Outros posts</h3>
	                    </div>
	                    <ul class="posts">
	                      
	                        <li>
	                          <span><i class="mini-ico-calendar"></i>03 Sep 2013</span> <br>
	                          <a class="post-link" href="/2013/09/03/resolvendo-o-problema-com-upload-de-arquivos-grandes-com-php-fpm-nginx/">Resolvendo o problema com upload de arquivos grandes no Nginx</a>
	                        </li>
	                      
	                        <li>
	                          <span><i class="mini-ico-calendar"></i>16 Aug 2013</span> <br>
	                          <a class="post-link" href="/2013/08/16/melhorando-a-completacao-de-codigo-auto-complete-do-netbeans/">Melhorando a completação de código (auto-complete) do NetBeans</a>
	                        </li>
	                      
	                        <li>
	                          <span><i class="mini-ico-calendar"></i>18 Apr 2013</span> <br>
	                          <a class="post-link" href="/2013/04/18/alterando-a-pasta-padrao-de-projetos-do-netbeans/">Alterando a pasta padrão de projetos do NetBeans</a>
	                        </li>
	                      
	                        <li>
	                          <span><i class="mini-ico-calendar"></i>24 Mar 2013</span> <br>
	                          <a class="post-link" href="/2013/03/24/php-gtk-no-lion/">PHP-GTK no Lion</a>
	                        </li>
	                      
	                        <li>
	                          <span><i class="mini-ico-calendar"></i>08 Apr 2012</span> <br>
	                          <a class="post-link" href="/2012/04/08/brincando-com-yql-yahoo-query-language/">Brincando com YQL - Yahoo Query Language</a>
	                        </li>
	                      
	                        <li>
	                          <span><i class="mini-ico-calendar"></i>08 Apr 2012</span> <br>
	                          <a class="post-link" href="/2012/04/08/daemons-em-php/">Daemons em PHP</a>
	                        </li>
	                      
	                        <li>
	                          <span><i class="mini-ico-calendar"></i>08 Apr 2012</span> <br>
	                          <a class="post-link" href="/2012/04/08/utilizando-php-na-linha-de-comando-com-zend-framework/">Utilizando PHP na linha de comando com Zend Framework</a>
	                        </li>
	                      
	                        <li>
	                          <span><i class="mini-ico-calendar"></i>21 Jan 2011</span> <br>
	                          <a class="post-link" href="/2011/01/21/trabalhando-com-imagens-utilizando-a-biblioteca-imagick/">Trabalhando com imagens utilizando a biblioteca Imagick</a>
	                        </li>
	                      
	                        <li>
	                          <span><i class="mini-ico-calendar"></i>26 Sep 2009</span> <br>
	                          <a class="post-link" href="/2009/09/26/nginx/">Nginx</a>
	                        </li>
	                      
	                        <li>
	                          <span><i class="mini-ico-calendar"></i>22 Apr 2008</span> <br>
	                          <a class="post-link" href="/2008/04/22/backup-incremental-simples-e-indolor/">Backup incremental simples e indolor</a>
	                        </li>
	                      
	                        <li>
	                          <span><i class="mini-ico-calendar"></i>05 Oct 2007</span> <br>
	                          <a class="post-link" href="/2007/10/05/internacionalizando-aplicacoes-baseadas-no-cakephp-1-2/">Internacionalizando Aplicações baseadas no CakePHP 1.2</a>
	                        </li>
	                      
	                        <li>
	                          <span><i class="mini-ico-calendar"></i>22 Sep 2007</span> <br>
	                          <a class="post-link" href="/2007/09/22/criando-um-access-point/">Criando um Access Point</a>
	                        </li>
	                      
	                    </ul>
	                </div>
	                <!-- end: Text Widget -->
	            </div>
	            <!-- end: Sidebar -->
	        </div>
	        <!--end: Row -->
	    </div>
	    <!--end: Container-->
	</div>
	<!-- end: Wrapper  -->

    <!-- start: Footer Menu -->
    <div id="footer-menu" class="hidden-tablet hidden-phone">
        <!-- start: Container -->
        <div class="container">
            <!-- start: Row -->
            <div class="row">
                <!-- start: Footer Menu Logo -->
                <div class="span2">
                    <div id="footer-menu-logo">
                        <a class="brand" href="/">mrprompt</a>
                    </div>
                </div>
                <!-- end: Footer Menu Logo -->

                <!-- start: Footer Menu Links-->
                <div class="span9">
                    <div id="footer-menu-links">
                        <ul id="footer-nav">
                            <li><a href="/">Início</a></li>
                            <li><a href="/sobre">Sobre</a></li>
                            <li><a href="/servicos">Serviços</a></li>
                            <li><a href="/blog">Blog</a></li>
                            <li><a href="/contato">Contato</a></li>
                        </ul>
                    </div>
                </div>
                <!-- end: Footer Menu Links-->

                <!-- start: Footer Menu Back To Top -->
                <div class="span1">
                    <div id="footer-menu-back-to-top">
                        <a href="#"></a>
                    </div>
                </div>
                <!-- end: Footer Menu Back To Top -->
            </div>
            <!-- end: Row -->
        </div>
        <!-- end: Container  -->
    </div>
    <!-- end: Footer Menu -->

    <!-- start: Copyright -->
    <div id="copyright">
        <!-- start: Container -->
        <div class="container">
            <div class="sixteen columns">
                <p>
                    &copy; 2014 - <a href="http://mrprompt.com.br">mrprompt.com.br</a>
                </p>
            </div>
        </div>
        <!-- end: Container  -->
    </div>
    <!-- end: Copyright -->

    <!-- start: Java Script -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/js/jquery-1.8.2.js"></script>
    <script src="/js/isotope.js"></script>
    <script src="/js/jquery.imagesloaded.js"></script>
    <script src="/js/bootstrap.js"></script>
    <script src="/js/flexslider.js"></script>
    <script src="/js/carousel.js"></script>
    <script src="/js/jquery.cslider.js"></script>
    <script src="/js/slider.js"></script>
    <script src="/js/fancybox.js"></script>
    <script src="/js/twitter.js"></script>
    <script defer="defer" src="/js/custom.js"></script>
    <!-- start analytics -->
    <script>
        (function(i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r;
            i[r] = i[r] || function() {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m)
        })(window, document, 'script',
                '//www.google-analytics.com/analytics.js', 'ga');

        ga('create', 'UA-1337986-1', 'mrprompt.com.br');
        ga('send', 'pageview');
    </script>
    <!-- end analytics -->
    <!-- end: Java Script -->
</body>
</html>
<!-- Localized -->

